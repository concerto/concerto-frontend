<link rel="import" href="bower_components/core-ajax/core-ajax.html">

<link rel="import" href="concerto-field.html">
<script src="utils.js"></script>

<!--
The `concerto-screen` element provides the main Concerto screen.

@element concerto-screen
@status alpha
-->
<polymer-element name="concerto-screen" attributes="screenId baseURL">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        width: 100%;
        height: 100%;
      }
      .position {
        position: absolute;
        overflow: hidden;
      }
      .template {
        width: 100%;
        height: 100%;
        background-size: 100% 100%;
        background-repeat: no-repeat;
      }
    </style>
    <core-ajax id="screenData"
      url="{{baseURL}}/frontend/{{screenId}}/setup.json"
      handleAs="json" auto
      on-core-response="{{handleScreenData}}">
    </core-ajax>
    <template bind if="{{template.id}}">
      <div id="template_{{template.id}}" class="template"
        style="background-image: url('{{template.path | resolveURL(baseURL)}}');">
        <template repeat="{{position in template.positions}}">
          <div class="position" id="position_{{position.id}}"
            style="left: {{position.left * 100}}%;
                   top: {{position.top * 100}}%;
                   width: {{(position.right - position.left) * 100}}%;
                   height: {{(position.bottom - position.top) * 100}}%;">
            <concerto-field screenId="{{screenId}}"
              fieldId="{{position.field.id}}"
              fieldName="{{position.field.name}}"
              baseURL="{{baseURL}}"
              contentStyle="{{position.style}}">
            </concerto-field>
          </div>
        </template>
      </div>
    </template>
    <!-- ajax request for changes to screen setup -->
    <core-ajax id="updateScreenData"
      url="{{baseURL}}/frontend/{{screenId}}/setup.json"
      handleAs="json"
      on-core-response="{{refreshScreen}}">
    </core-ajax>
  </template>

  <script>
    Polymer({
      /**
       * ID of this screen.
       *
       * @attribute screenId
       * @type Number
       * @default 0
       */
      screenId: 0,

      /**
       * Base path to prepend to all URLs.
       *
       * @attribute baseURL
       * @type String
       * @default ''
       */
      baseURL: '',

      /**
       * Name of this screen.
       *
       * @attribute name
       * @type String
       * @default ''
       */

      /**
       * Template being shown.
       *
       * @attribute template
       * @type Object
       * @default {}
       */

      publish: {
        name: {
          value: '',
          reflect: true
        },
      },

      created: function (){
        this.template = {};
      },

      handleScreenData: function(event, response) {
        var data = response.response;
        this.name = data.name;
        this.template = data.template;

        // periodically check screen setup for changes
        setInterval(this.checkScreenData, 1000, this.$.updateScreenData);
      },

      checkScreenData: function(ajax) {
        // get screen setup.json
        ajax.go();
      }, 

      refreshScreen: function(event, response) {
        // reload screen if changes are found in screen setup
        var template = this.template;
        var response = response.response;

        // Check for changes to screen's effective template
        if (template.name != response.template.name) {
          location.reload();
        }

        // Check for any changes to positions
        for (var position in this.template.positions) {
          if (!(position in response.template.positions)) {
            location.reload();
          }
        }
      }
    });
  </script>
</polymer-element>
